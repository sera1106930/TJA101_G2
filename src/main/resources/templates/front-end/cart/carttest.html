<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的購物車 - EatFast</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
          theme: {
            extend: {
              fontFamily: {
                sans: ['Noto Sans TC', 'sans-serif'],
              },
              colors: {
                'brand-bg': '#FDFBF6',
                'brand-container': '#F5EFE6',
                'brand-primary': '#A67B5B',
                'brand-primary-hover': '#8C684A',
                'brand-text': '#5D534A',
                'brand-deep': '#3C2A21',
                'brand-accent': '#E1A87A',
              }
            }
          }
        }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .btn-primary-custom {
            background-color: var(--colors-brand-primary);
            color: white;
        }
        .btn-primary-custom:hover {
            background-color: var(--colors-brand-primary-hover);
        }
        .btn-danger-custom {
            background-color: #EF4444;
            color: white;
        }
        .btn-danger-custom:hover {
            background-color: #DC2626;
        }
        .btn-secondary-custom {
            background-color: #E5E7EB;
            color: #4B5563;
        }
        .btn-secondary-custom:hover {
            background-color: #D1D5DB;
        }
        .meal-placeholder-img {
            background-color: #F3F4F6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #9CA3AF;
        }
        .meal-placeholder-img i {
            font-size: 2rem;
        }
    </style>
</head>
<body class="bg-brand-bg text-brand-text antialiased">

<!-- 頁首與購物車內容保持不變 -->

<script th:inline="javascript">
document.addEventListener('DOMContentLoaded', function () {
    const IS_LOGGED_IN = /*[[${session.loggedInMemberId != null}]]*/ false;
    const MEMBER_ID = /*[[${session.loggedInMemberId}]]*/ null;
    const contextPath = /*[[@{/}]]*/ '/';
    const API_CART_BASE_URL = contextPath + 'cart/api';

    const cartItemsBody = document.getElementById('cart-items-body');
    const cartTotalAmountSpan = document.getElementById('cart-total-amount');
    const emptyCartMessageDiv = document.getElementById('empty-cart-message');
    const cartContentDiv = document.getElementById('cart-content');
    const notLoggedInMessageDiv = document.getElementById('not-logged-in-message');

    function toggleEmptyCartMessage(showEmpty) {
        if (showEmpty) {
            cartContentDiv.classList.add('hidden');
            emptyCartMessageDiv.classList.remove('hidden');
        } else {
            cartContentDiv.classList.remove('hidden');
            emptyCartMessageDiv.classList.add('hidden');
        }
    }
    
    //監聽購物車備註欄位
    // 取得備註欄位 DOM
const notesTextarea = document.getElementById('notes');

if (notesTextarea) {
    notesTextarea.addEventListener('blur', async () => {
        const newCustomization = notesTextarea.value.trim();

        if (!IS_LOGGED_IN || !MEMBER_ID) return;

        try {
            const response = await fetch(`${API_CART_BASE_URL}/member/${MEMBER_ID}/customization`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ mealCustomization: newCustomization })
            });

            if (!response.ok) throw new Error('儲存失敗');

            showMessage('success', '備註已更新！');
            loadCart();
        } catch (error) {
            console.error('更新備註失敗:', error);
            showMessage('error', '儲存備註失敗');
        }
    });
}

    

    function displayNotLoggedIn() {
        cartContentDiv.classList.add('hidden');
        emptyCartMessageDiv.classList.add('hidden');
        notLoggedInMessageDiv.classList.remove('hidden');
    }

    function renderCartItems(items) {
        cartItemsBody.innerHTML = '';
        let totalAmount = 0;

        items.forEach(item => {
            const mealPrice = item.mealPrice;
            const subtotal = mealPrice * item.quantity;
            totalAmount += subtotal;

            const row = document.createElement('tr');
            row.className = 'border-b';
            row.innerHTML = `
                <td class="py-4 flex items-center">
                    <img src="${item.mealPicUrl || contextPath + 'images/meal_default.png'}" alt="${item.mealName}" class="w-16 h-16 rounded-md mr-4 object-cover meal-placeholder-img">
                    <div>
                        <span class="font-medium">${item.mealName || '未知餐點'}</span>
                        <p class="text-sm text-gray-500">(${item.storeName || ''}) ${item.mealCustomization ? '<br>備註: ' + item.mealCustomization : ''}</p>
                    </div>
                </td>
                <td class="py-4 text-right">NT$ ${mealPrice}</td>
                <td class="py-4 text-center">${item.quantity}</td>
                <td class="py-4 text-right">NT$ ${subtotal}</td>
                <td class="py-4 text-center">
                    <button class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition-colors shadow-sm">刪除</button>
                </td>
            `;
            cartItemsBody.appendChild(row);
        });
        cartTotalAmountSpan.textContent = totalAmount;
        toggleEmptyCartMessage(false);
        if (IS_LOGGED_IN && notLoggedInMessageDiv) {
            notLoggedInMessageDiv.classList.add('hidden');
        }
    }
    //客製化欄位備註
    if (notesTextarea && items.length > 0) {
        // 使用第一筆的備註作為 textarea 的值
        notesTextarea.value = items[0].mealCustomization || '';
    }

    async function loadCart() {
        if (!IS_LOGGED_IN || MEMBER_ID === null) {
            displayNotLoggedIn();
            return;
        }

        try {
            const response = await fetch(`${API_CART_BASE_URL}/member/${MEMBER_ID}`);
            if (response.status === 204) {
                toggleEmptyCartMessage(true);
                return;
            }
            if (!response.ok) {
                toggleEmptyCartMessage(true);
                return;
            }
            const cartItems = await response.json();
            if (cartItems.length === 0) {
                toggleEmptyCartMessage(true);
            } else {
                renderCartItems(cartItems);
            }
        } catch (error) {
            console.error('載入購物車發生錯誤:', error);
            toggleEmptyCartMessage(true);
        }
    }

    loadCart();
});
</script>

</body>
</html>