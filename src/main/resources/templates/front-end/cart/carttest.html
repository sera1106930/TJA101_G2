<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>我的購物車 - EatFast</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
	href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
	rel="stylesheet">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
<script>
        tailwind.config = {
          theme: {
            extend: {
              fontFamily: {
                sans: ['Noto Sans TC', 'sans-serif'],
              },
              colors: {
                'brand-bg': '#FDFBF6',
                'brand-container': '#F5EFE6',
                'brand-primary': '#A67B5B',
                'brand-primary-hover': '#8C684A',
                'brand-text': '#5D534A',
                'brand-deep': '#3C2A21',
                'brand-accent': '#E1A87A',
              }
            }
          }
        }
    </script>
<style>
body {
	font-family: 'Noto Sans TC', sans-serif;
	background-color: #FDFBF6;
	color: #5D534A;
}
</style>
</head>
<body class="bg-brand-bg text-brand-text antialiased">

    <header class="bg-white shadow-md fixed top-0 left-0 w-full z-50 transition-all duration-300">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            
            <div class="flex-shrink-0">
                <a th:href="@{/welcome}" class="flex items-center">
                    <img th:src="@{/images/123.png}" alt="Logo" class="w-12 h-12 rounded-full mr-2">
                    <span class="text-xl font-bold text-brand-deep">EatFast 早安！</span>
                </a>
            </div>

            <div class="hidden md:flex space-x-8"> 
                <a href="/welcome" class="text-brand-text hover:text-brand-primary font-medium text-lg">關於我們</a>
                <a href="/welcome" class="text-brand-text hover:text-brand-primary font-medium text-lg">最新消息</a>
                <a th:href="@{/store/view}" class="text-brand-primary font-bold text-lg">門市據點</a> 
                <a th:href="@{/welcome}" class="text-brand-text hover:text-brand-primary font-medium text-lg">我要訂餐</a> 
                <a th:href="@{/cart}" class="text-brand-text hover:text-brand-primary font-medium text-lg">購物車</a>
            </div>

            <div class="hidden md:flex items-center space-x-4">
                <a href="/api/v1/auth/member-login" class="bg-brand-accent text-brand-deep font-bold px-5 py-2 rounded-full hover:bg-orange-400 transition-colors shadow-sm">
                    登入/註冊
                </a>
            </div>

        </nav>
    </header>

	<main class="container mx-auto p-4 md:p-8 pt-28 md:pt-32">
		<div class="flex flex-col md:flex-row gap-8">

			<aside class="w-full md:w-64 flex-shrink-0">
				<div class="bg-brand-container p-4 rounded-lg shadow-md h-full">
					<h2
						class="text-xl font-bold text-brand-deep mb-4 border-b-2 border-gray-300 pb-2">我要訂餐</h2>
					<nav class="space-y-2">
						<a th:href="@{/meal/list(type='漢堡')}"
							class="block w-full text-left px-4 py-2 rounded-md transition-colors duration-200 hover:bg-brand-primary hover:text-white">漢堡</a>
						<a th:href="@{/meal/list(type='吐司')}"
							class="block w-full text-left px-4 py-2 rounded-md transition-colors duration-200 hover:bg-brand-primary hover:text-white">吐司</a>
						<a th:href="@{/meal/list(type='麵類')}"
							class="block w-full text-left px-4 py-2 rounded-md transition-colors duration-200 hover:bg-brand-primary hover:text-white">麵類</a>
						<a th:href="@{/meal/list(type='蛋餅')}"
							class="block w-full text-left px-4 py-2 rounded-md transition-colors duration-200 hover:bg-brand-primary hover:text-white">蛋餅</a>
						<a th:href="@{/meal/list(type='飲品')}"
							class="block w-full text-left px-4 py-2 rounded-md transition-colors duration-200 hover:bg-brand-primary hover:text-white">飲品</a>
					</nav>
				</div>
			</aside>

			<section class="flex-grow">
				<div
					class="bg-white p-6 md:p-8 rounded-lg shadow-md border border-gray-200">
					<h1 class="text-2xl font-bold text-brand-primary mb-6 text-center">我的購物車</h1>

					<div id="cart-content">
						<table class="w-full text-left mb-6">
							<thead class="border-b-2 border-gray-300">
								<tr>
									<th class="py-2 font-semibold">餐點品項</th>
									<th class="py-2 font-semibold text-right w-24">單價</th>
									<th class="py-2 font-semibold text-center w-32">數量</th>
									<th class="py-2 font-semibold text-right w-24">小計</th>
									<th class="w-20"></th>
								</tr>
							</thead>
							<tbody id="cart-items-body">
							</tbody>
						</table>

						<div class="flex justify-start mb-8">
							<button id="clear-cart-btn"
								class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-700 text-sm flex items-center shadow-sm transition-colors">
								<i class="fas fa-trash-alt mr-2"></i>清空購物車
							</button>
						</div>

						<div class="space-y-4 border-t border-gray-300 pt-8 mt-8">
							<div class="flex items-center">
								<label for="pickup-store"
									class="w-24 font-semibold flex-shrink-0">取餐門市</label> <input
									type="text" id="pickup-store" value="二號店"
									class="flex-grow p-2 border rounded-md bg-gray-100" readonly>
							</div>
							<div class="flex items-center">
								<label for="pickup-time"
									class="w-24 font-semibold flex-shrink-0">取餐時間</label> <select
									id="pickup-time" class="flex-grow p-2 border rounded-md"></select>
							</div>
							<div class="flex items-start">
								<label for="notes" class="w-24 font-semibold mt-2 flex-shrink-0">備註</label>
								<textarea id="notes" rows="3"
									class="flex-grow p-2 border rounded-md"
									placeholder="例如：不加生菜、飲料去冰等..."></textarea>
							</div>
						</div>

						<div class="border-t mt-8 pt-6 flex justify-between items-center">
							<div>
								<span class="text-xl font-bold text-brand-text">總金額： <span
									id="cart-total-amount" class="text-2xl text-red-600">NT$
										0</span>
								</span>
							</div>
							<div class="flex items-center space-x-4">
								<a th:href="@{/}"
									class="bg-gray-200 text-gray-800 font-bold px-8 py-3 rounded-md hover:bg-gray-300 transition-colors">←
									繼續購物</a>
								<button id="checkout-btn"
									class="bg-brand-accent text-brand-deep font-bold px-8 py-3 rounded-lg hover:bg-orange-400 transition-colors shadow">前往結帳</button>
							</div>
						</div>
					</div>

					<div id="empty-cart-message"
						class="text-center text-lg text-gray-500 py-8 hidden">
						<p>您的購物車是空的，快去選購吧！</p>
						<p class="mt-4">
							<a th:href="@{/}"
								class="bg-brand-primary text-white px-4 py-2 rounded hover:bg-brand-primary-hover">開始購物</a>
						</p>
					</div>
				</div>
			</section>
		</div>
	</main>

	<footer
		class="bg-brand-deep text-brand-container text-center p-6 mt-16">
		<p>&copy; 2025 EatFast 早餐店 - 版權所有</p>
	</footer>

	<script th:inline="javascript">
        // ... (時間選項生成的腳本保持不變) ...
        document.addEventListener('DOMContentLoaded', function() {
            const pickupTimeSelect = document.getElementById('pickup-time');
            if (pickupTimeSelect) {
                // ... (此處程式碼不變)
            }

            const USE_MOCK_DATA = true;
            const cartItemsBody = document.getElementById('cart-items-body');
            const cartTotalAmountSpan = document.getElementById('cart-total-amount');
            const emptyCartMessageDiv = document.getElementById('empty-cart-message');
            const cartContentDiv = document.getElementById('cart-content');

            function renderCartItems(items) {
                cartItemsBody.innerHTML = '';
                let totalAmount = 0;
                items.forEach(item => {
                    const subtotal = item.mealPrice * item.quantity;
                    totalAmount += subtotal;
                    const row = document.createElement('tr');
                    row.className = 'border-b';
                    
                    // 【修正】在 innerHTML 中補回單價的 <td> 儲存格
                    row.innerHTML = `
                        <td class="py-4 flex items-center">
                            <img src="/demo/images/hamburger.png" alt="${item.mealName}" class="w-16 h-16 rounded-md mr-4 object-cover">
                            <div>
                                <span class="font-medium">${item.mealName || '未知餐點'}</span>
                                <p class="text-sm text-gray-500">(${item.storeName || '預設門市'})</p>
                                <p class="text-sm text-gray-500">${item.mealCustomization ? '備註: ' + item.mealCustomization : ''}</p>
                            </div>
                        </td>
                        <td class="py-4 align-middle text-right">NT$ ${item.mealPrice}</td>
                        <td class="py-4 align-middle text-center">
                            <div class="flex items-center justify-center">
                                <button class="px-2 py-1 border rounded-l-md">-</button>
                                <input type="text" value="${item.quantity}" class="w-12 text-center border-t border-b">
                                <button class="px-2 py-1 border rounded-r-md">+</button>
                            </div>
                        </td>
                        <td class="py-4 align-middle text-right">NT$ ${subtotal}</td>
                        <td class="py-4 align-middle text-center">
                            <button class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition-colors shadow-sm delete-btn" data-cart-id="${item.cartId}">刪除</button>
                        </td>
                    `;
                    cartItemsBody.appendChild(row);
                });
                cartTotalAmountSpan.textContent = `NT$ ${totalAmount}`;
            }

            
        });
    </script>

	<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- 區塊 1: 動態生成取餐時間選項 ---
        const pickupTimeSelect = document.getElementById('pickup-time');
        if (pickupTimeSelect) {
            const now = new Date();
            now.setMinutes(now.getMinutes() + 20); // 加上20分鐘準備時間
            const minutes = now.getMinutes();
            const roundedMinutes = Math.ceil(minutes / 15) * 15; // 調整到下一個15分鐘的整點
            now.setMinutes(roundedMinutes, 0, 0);

            const closingTime = new Date(now);
            closingTime.setHours(20, 0, 0, 0); // 假設營業到晚上 8 點
            
            while (now <= closingTime) {
                const option = document.createElement('option');
                const hours = String(now.getHours()).padStart(2, '0');
                const mins = String(now.getMinutes()).padStart(2, '0');
                const timeString = `${hours}:${mins}`;
                option.value = timeString;
                option.textContent = timeString;
                pickupTimeSelect.appendChild(option);
                now.setMinutes(now.getMinutes() + 15);
            }
        }

        // --- 區塊 2: 購物車核心互動邏輯 ---
        
        // --- 設定 ---
        const USE_MOCK_DATA = true; // true: 使用假資料, false: 使用真實 API
        const contextPath = /*[[@{/}]]*/ '/demo/'; // Thymeleaf 解析的 context path
        const API_CART_BASE_URL = contextPath + 'api/cart'; // 假設的真實 API 路徑
        const MEMBER_ID = 1; 

        // --- 獲取頁面元素 ---
        const cartItemsBody = document.getElementById('cart-items-body');
        const cartTotalAmountSpan = document.getElementById('cart-total-amount');
        const emptyCartMessageDiv = document.getElementById('empty-cart-message');
        const cartContentDiv = document.getElementById('cart-content');
        const clearCartBtn = document.getElementById('clear-cart-btn');
        const checkoutBtn = document.getElementById('checkout-btn');

        // --- 主要函式 ---

        // 渲染購物車列表
        function renderCartItems(items) {
            cartItemsBody.innerHTML = '';
            let totalAmount = 0;
            items.forEach(item => {
                const subtotal = item.mealPrice * item.quantity;
                totalAmount += subtotal;
                const row = document.createElement('tr');
                row.className = 'border-b';
                
                // 動態產生每一行的 HTML
                row.innerHTML = `
                    <td class="py-4 flex items-center">
                        <img src="/demo/images/hamburger.png" alt="${item.mealName}" class="w-16 h-16 rounded-md mr-4 object-cover">
                        <div>
                            <span class="font-medium">${item.mealName || '未知餐點'}</span>
                            <p class="text-sm text-gray-500">(${item.storeName || '預設門市'})</p>
                            <p class="text-sm text-gray-500">${item.mealCustomization ? '備註: ' + item.mealCustomization : ''}</p>
                        </div>
                    </td>
                    <td class="py-4 align-middle text-right">NT$ ${item.mealPrice}</td>
                    <td class="py-4 align-middle">
                        <div class="flex items-center justify-center">
                            <button class="px-2 py-1 border rounded-l-md">-</button>
                            <input type="text" value="${item.quantity}" class="w-12 text-center border-t border-b">
                            <button class="px-2 py-1 border rounded-r-md">+</button>
                        </div>
                    </td>
                    <td class="py-4 align-middle text-right">NT$ ${subtotal}</td>
                    <td class="py-4 align-middle text-center">
                        <button class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition-colors shadow-sm delete-btn" data-cart-id="${item.cartId}">刪除</button>
                    </td>
                `;
                cartItemsBody.appendChild(row);
            });
            cartTotalAmountSpan.textContent = `NT$ ${totalAmount}`;
        }
        
        // 顯示或隱藏「購物車為空」的訊息
        function toggleEmptyCartMessage(showEmpty) {
            if (showEmpty) {
                cartContentDiv.classList.add('hidden');
                emptyCartMessageDiv.classList.remove('hidden');
            } else {
                cartContentDiv.classList.remove('hidden');
                emptyCartMessageDiv.classList.add('hidden');
            }
        }
        
        // 載入購物車資料（主函式）
        async function loadCart() {
            if (USE_MOCK_DATA) {
                const mockCartItems = [
                    { cartId: 1001, mealName: "招牌總匯三明治", mealPrice: 75, storeName: "旗艦店", quantity: 2, mealCustomization: "不要美乃滋" },
                    { cartId: 1002, mealName: "特選大冰奶", mealPrice: 45, storeName: "旗艦店", quantity: 3, mealCustomization: "" },
                    { cartId: 1003, mealName: "蘑菇鐵板麵", mealPrice: 80, storeName: "二號店", quantity: 1, mealCustomization: "加辣" }
                ];
                await new Promise(resolve => setTimeout(resolve, 300)); // 模擬網路延遲
                
                if(mockCartItems && mockCartItems.length > 0) {
                    toggleEmptyCartMessage(false);
                    renderCartItems(mockCartItems);
                } else {
                    toggleEmptyCartMessage(true);
                }
            } else {
                // 未來要串接真實 API 的邏輯會放在這裡
                try {
                    // ... fetch(...) ...
                } catch (error) {
                    console.error("載入購物車失敗:", error);
                    toggleEmptyCartMessage(true);
                }
            }
        }
        
        // 綁定所有按鈕的點擊事件
        function attachEventListeners() {
            clearCartBtn.addEventListener('click', () => {
                if(confirm('您確定要清空整個購物車嗎？')) {
                    alert("（模擬）已清空購物車！");
                    // 在真實情境中，這裡會呼叫後端 API
                    toggleEmptyCartMessage(true);
                }
            });
            
            checkoutBtn.addEventListener('click', () => {
                alert("結帳功能尚未實作！");
            });
        }

        // --- 頁面載入時執行的初始操作 ---
        loadCart();
        attachEventListeners();
    });
</script>

</body>
</html>