<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>餐點菜單 | EatFast 早餐店</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
	href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
	rel="stylesheet">

<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">

<style>
.bg-milktea {
	background-color: #F7F2ED;
}

.bg-card {
	background-color: #fff8f2;
}

.text-milktea-dark {
	color: #A67B5B;
}

.border-milktea {
	border-color: #E5D0B6;
}

.btn-primary {
	background: #A67B5B;
	color: white;
}

.btn-primary:hover {
	background: #8B5A3C;
}

.btn-outline {
	border: 1.5px solid #A67B5B;
	color: #A67B5B;
}

.btn-outline:hover {
	background: #F3E5D6;
}

.active-category {
	background: #E5D0B6;
	color: #A67B5B;
	font-weight: bold;
}

:root {
    --bg-color: #FDFBF6;
    --container-bg: #FFFFFF;
    --primary-color: #A67B5B;
    --primary-hover: #8C684A;
    --text-color: #5D534A;
    --border-color: #DED0B6;
    --header-bg: #F5EFE6;
    --accent-color: #E1A87A;
    --shadow-light: rgba(0, 0, 0, 0.1);
    --shadow-medium: rgba(0, 0, 0, 0.15);
}

 body {
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background: linear-gradient(135deg, var(--bg-color) 0%, var(--header-bg) 100%);
            min-height: 100vh;
        }
        
/* Navigation Bar */
        .nav-fixed {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px; /* 固定導航欄高度 */
            background: rgba(255, 255, 255, 0.95);
            padding: 0.5rem 0;
            box-shadow: 0 2px 10px var(--shadow-light);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
            color: var(--primary-color);
        }

        .nav-logo-icon {
            width: 35px; /* 調整 logo 大小 */
            height: 35px;
            object-fit: contain;
        }

       .nav-logo-text {
            font-size: 1.2rem; /* 調整導航欄文字大小 */
            font-weight: 700;
        }



        .nav-menu {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-link {
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
            position: relative;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        .nav-link:hover::after {
            width: 100%;
        }

        .nav-login {
            background: var(--primary-color);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .nav-login:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }
		/* 響應式設計 */
        @media (max-width: 768px) {
            .header {
                padding: 4rem 0 3rem;
            }
            
            .brand-title {
                font-size: 2.5rem;
            }
            
            .brand-subtitle {
                font-size: 1.2rem;
            }
            
            .nav-logo-text {
                font-size: 1rem;
            }
            
            .nav-fixed {
                height: 50px;
            }
            
            .nav-logo-icon {
                width: 30px;
                height: 30px;
            }
        }
        
        @media (max-width: 480px) {
            .main-content {
                padding: 2rem 1rem;
            }
            
            .header-content {
                padding: 0 1rem;
            }
            
            .feature-card {
                padding: 1.5rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .feature-actions {
                flex-direction: column;
            }
            
            .news-grid {
                grid-template-columns: 1fr;
            }
            .product-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Footer 區域 */
        .footer {
            background: var(--primary-hover);
            color: white;
            text-align: center;
            padding: 2rem;
            margin-top: 4rem;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .footer-link {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        
        .footer-link:hover {
            color: var(--accent-color);
        }
        
        .copyright {
            opacity: 0.8;
            font-size: 0.9rem;
        }
/* 登出確認模態框樣式 */
        .logout-modal {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(5px);
    z-index: 10000;
    opacity: 0;
    transition: opacity 0.3s;
}
.logout-modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 1;
}
.logout-modal-content {
    background: var(--container-bg);
    border-radius: 20px;
    padding: 2.5rem;
    max-width: 450px;
    width: 90%;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    transform: scale(0.7);
    transition: transform 0.3s;
    border: 1px solid var(--border-color);
}
.logout-modal.show .logout-modal-content {
    transform: scale(1);
}
.logout-modal-icon {
    width: 80px; height: 80px;
    background: linear-gradient(135deg, #ff6b6b, #ee5a24);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 1.5rem;
    color: white; font-size: 2.5rem;
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0% {transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7);}
    70% {transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255,107,107,0);}
    100% {transform: scale(1); box-shadow: 0 0 0 0 rgba(255,107,107,0);}
}
.logout-modal-title { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); margin-bottom: 1rem; }
.logout-modal-message { font-size: 1.1rem; color: var(--text-color); margin-bottom: 2rem; line-height: 1.6; }
.logout-modal-actions { display: flex; gap: 1rem; justify-content: center; }
.logout-btn {
    padding: 0.8rem 2rem; border: none; border-radius: 50px;
    font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s;
    display: flex; align-items: center; gap: 0.5rem; min-width: 120px; justify-content: center;
}
.logout-btn-confirm {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
}
.logout-btn-confirm:hover {
    background: linear-gradient(135deg, #c82333, #bd2130);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
}
.logout-btn-cancel {
    background: var(--container-bg);
    color: var(--text-color);
    border: 2px solid var(--border-color);
}
.logout-btn-cancel:hover {
    background: var(--header-bg);
    border-color: var(--primary-color);
    color: var(--primary-color);
    transform: translateY(-2px);
}
.logout-loading {
    display: none;
    align-items: center;
    gap: 0.5rem;
    justify-content: center;
    margin-top: 1.5rem;
}
.logout-spinner {
    width: 20px; height: 20px;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: #c82333;
    animation: spin 1s ease-in-out infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

        /* 響應式模態框 */
        @media (max-width: 480px) {
            .logout-modal-content {
                padding: 2rem;
                margin: 1rem;
            }

            .logout-modal-actions {
                flex-direction: column;
            }

            .logout-btn {
                width: 100%;
            }
        }
        
        /* 動畫效果 */
        .fade-in {
            animation: fadeIn 0.8s ease-in;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .slide-in {
            animation: slideIn 0.6s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

</style>
</head>
<body class="bg-milktea min-h-screen">
	<!-- 成功加入購物車的提示彈窗 -->
	<div id="toast-container"
		class="fixed inset-0 flex items-center justify-center z-[1001] pointer-events-none"></div>
	<!-- 動態設定是否登入 -->
	<script th:inline="javascript">
	    var isLoggedIn = /*[[${session.loggedInMemberId != null && session.isLoggedIn != null && session.isLoggedIn}]]*/ false;
	    var memberId = /*[[${session.loggedInMemberId}]]*/ null;
	    </script>

	<!-- Navbar -->
	<nav class="nav-fixed">
        <div class="nav-container">
            <a href="/welcome" class="nav-logo">
                <img src="images/123.png" alt="EatFast Logo" class="nav-logo-icon">
                <span class="nav-logo-text">EatFast 早餐店</span>
            </a>
            
            <div class="nav-menu">
            	<a href="/news/list" class="nav-link">最新消息</a>
            	<a href="/store/storelist" class="nav-link">門市據點</a>
                <a href="/menu" class="nav-link">餐點菜單</a>
                <!-- 根據登入狀態顯示不同內容 -->
                <a th:if="${session.loggedInMemberId != null && session.isLoggedIn != null && session.isLoggedIn}" 
                   th:href="@{/member/dashboard}" class="nav-link">會員專區</a>
                <a th:unless="${session.loggedInMemberId != null && session.isLoggedIn != null && session.isLoggedIn}" 
                   th:href="@{/api/v1/auth/member-login}" class="nav-link">會員專區</a>
                <a href="/feedback/form" class="nav-link">聯繫我們</a>
                <a th:if="${session.loggedInMemberId != null && session.isLoggedIn != null && session.isLoggedIn}" 
                   th:href="@{/cart}" class="nav-link">購物車</a>
                <a th:unless="${session.loggedInMemberId != null && session.isLoggedIn != null && session.isLoggedIn}" 
                   th:href="@{/api/v1/auth/member-login}" class="nav-link">購物車</a>
			</div>

<!-- 登入按鈕根據登入狀態變化 -->
            <div th:if="${session.loggedInMemberId != null && session.isLoggedIn != null && session.isLoggedIn}" 
                 class="nav-user-info" style="display: flex; align-items: center; gap: 1rem;">
                <span style="color: var(--primary-color);">歡迎, <span th:text="${session.memberName}"></span></span>
                <button type="button" class="nav-login" style="background-color: #dc3545; border: none; cursor: pointer;" 
                        onclick="confirmLogout()">
                    <i class="fas fa-sign-out-alt"></i> 登出
                </button>
                <!-- 隱藏的登出表單 -->
                <form id="logout-form" th:action="@{/api/v1/auth/logout}" method="post" style="display: none;">
                    <input type="hidden" name="_method" value="POST">
                </form>
            </div>
            <a th:unless="${session.loggedInMemberId != null && session.isLoggedIn != null && session.isLoggedIn}" 
               th:href="@{/api/v1/auth/member-login}" class="nav-login">
                <i class="fas fa-sign-in-alt"></i> 會員登入
            </a>
        </div>

<!-- 登出 Modal（新版） -->
<div class="logout-modal" id="logoutModal">
    <div class="logout-modal-content">
        <div class="logout-modal-icon">
            <i class="fas fa-sign-out-alt"></i>
        </div>
        <h3 class="logout-modal-title">登出確認</h3>
        <p class="logout-modal-message">您確定要登出系統嗎？</p>
        <div class="logout-modal-actions">
            <button class="logout-btn logout-btn-confirm" onclick="logout()">確定登出</button>
            <button class="logout-btn logout-btn-cancel" onclick="closeLogoutModal()">取消</button>
        </div>
        <div class="logout-loading" id="logoutLoading" style="display:none;">
            <div class="logout-spinner"></div>
            <span>登出中...</span>
        </div>
    </div>
</div>
		</div>
	</nav>


	<!-- 主內容區 -->
	<div class="max-w-7xl mx-auto py-8 flex flex-col md:flex-row gap-6 pt-24">

		<!-- 左側分類區 -->
		<aside
			class="w-1/5 min-w-[180px] bg-card rounded-2xl shadow-lg border border-milktea mr-8 p-6 h-fit">
			<!-- 門市下拉選單 -->
			<div class="mb-6 flex flex-col justify-start gap-2">
				<label for="storeSelector"
					class="text-milktea-dark font-semibold">選擇門市：</label> <select
					id="storeSelector" name="storeId" class="border rounded px-3 py-2 border-milktea focus:ring-milktea-dark focus:border-milktea-dark text-[#A67B5B] bg-white shadow-sm"
					onchange="handleStoreChange(this)">
					<option value="" disabled selected>請選擇門市</option>
					<option th:each="store : ${storeList}" th:value="${store.storeId}"
						th:text="${store.storeName}"
						th:selected="${store.storeId == session.selectedStoreId}">
					</option>
				</select>
			</div>
			<!-- 餐點種類列表 -->
			<h2 class="text-lg font-bold text-milktea-dark mb-4">餐點種類</h2>
			<ul class="space-y-2">
				<li><a th:href="@{/menu}"
					th:classappend="${param.type} == null ? 'active-category' : ''"
					class="block rounded px-4 py-2 hover:bg-[#f4ede6] transition">
						全部 </a></li>
				<li th:each="type : ${mealTypeListData}"><a
					th:href="@{'/menu?type=' + ${type.mealTypeId}}"
					th:classappend="${param.type != null and !#strings.isEmpty(param.type[0]) and T(java.lang.Long).valueOf(param.type[0]).equals(type.mealTypeId) ? 'active-category' : ''}"
					th:text="${type.mealName}"
					class="block rounded px-4 py-2 hover:bg-[#f4ede6] transition">
						餐點種類名稱 </a></li>
			</ul>
		</aside>



		<!-- 右側餐點清單 -->
		<main class="flex-1">
			<!-- 標題 -->
			<div class="mb-8 text-center">
				<h1 class="text-4xl font-bold text-milktea-dark tracking-wider mb-2">🍳
					早餐店菜單</h1>
				<p class="text-[#7a6451] text-base mb-2">現做早餐，選用新鮮食材，每一道都值得期待！</p>
				<span th:if="${currentMealTypeName != null}"
					th:text="'目前僅顯示：' + ${currentMealTypeName}"
					class="inline-block px-3 py-1 bg-[#F0E6D3] rounded text-[#A67B5B] text-sm">
				</span>

			</div>
			<!-- 餐點卡片區 -->
			<div
				class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8 pb-8">
				<div th:each="meal : ${mealListData}"
					class="bg-card rounded-2xl shadow-xl border border-milktea flex flex-col items-center p-6 hover:shadow-2xl transition-shadow duration-200 relative">
					<!-- 圖片區 + 漂浮購物車按鈕 -->
					<div
						class="relative w-40 h-40 mb-4 flex justify-center items-center">
						<img th:src="${meal.mealPicUrl}" alt="餐點圖片"
							class="w-40 h-40 object-cover rounded-xl border"
							onerror="this.onerror=null;this.src='/images/nopic.png';" />
					</div>
					<div class="w-full flex flex-col items-center">
						<h2 class="text-xl font-bold text-milktea-dark mb-1 text-center"
							th:text="${meal.mealName}"></h2>
						<div class="text-[#C7A083] text-lg font-semibold mb-2"
							th:text="'NT$ ' + ${meal.mealPrice}"></div>
					</div>

					<div class="flex items-center justify-center gap-2 mb-3">
					    <span class="star-display" data-meal-id="[[${meal.mealId}]]">
					      <span th:with="stars=${meal.avgStars}">
					        <th:block th:each="i : ${#numbers.sequence(1, 5)}">
					          <i th:if="${i <= T(java.lang.Math).floor(stars)}" class="fas fa-star text-yellow-400"></i>
					          <i th:if="${i == T(java.lang.Math).ceil(stars)} and ${stars > 0} and ${(stars - T(java.lang.Math).floor(stars)) >= 0.5}" class="fas fa-star-half-alt text-yellow-400"></i>
					          <i th:if="${(i > stars) and (i > T(java.lang.Math).ceil(stars) or (stars - T(java.lang.Math).floor(stars)) < 0.5)}" class="far fa-star text-[#DED0B6]"></i>
					        </th:block>
					        <span th:text="${stars} + ' / 5'" class="ml-1 text-sm text-[#A67B5B]"></span>
					      </span>
					    </span>
					</div>

					<div class="flex gap-2 w-full mt-auto">
						<!-- 已收藏表單 -->
						<form th:if="${meal.favored}" th:action="@{/member/removeFav}"
							method="post" class="flex-1">
							<input type="hidden" name="favMealId"
								th:value="${meal.favMealId}" /> <input type="hidden"
								name="redirectUrl"
								th:value="${param.type != null and !#strings.isEmpty(param.type[0]) ? '/menu?type=' + param.type[0] : '/menu'}" />
							<button type="submit"
								class="w-full rounded-lg px-3 py-2 text-sm text-center transition-all flex flex-col items-center justify-center btn-outline group"
								title="移除收藏">
								<i class="fas fa-heart" style="color: #d45a6b;"></i> <span
									class="ml-1 text-[#d45a6b] group-hover:text-[#b63a53]"></span>
							</button>
						</form>
						<!-- 未收藏表單 -->
						<form th:unless="${meal.favored}" th:action="@{/member/addFav}"
							method="post" class="flex-1" onsubmit="return checkLogin(event)">
							<input type="hidden" name="mealId" th:value="${meal.mealId}" />
							<input type="hidden" name="redirectUrl"
								th:value="${param.type != null and !#strings.isEmpty(param.type[0]) ? '/menu?type=' + param.type[0] : '/menu'}" />
							<button type="submit"
								class="w-full rounded-lg px-3 py-2 text-sm text-center transition-all flex flex-col items-center justify-center btn-outline group"
								title="加入收藏">
								<i class="far fa-heart group-hover:text-[#d45a6b]"
									style="color: #ccc;"></i> <span
									class="ml-1 text-[#A67B5B] group-hover:text-[#d45a6b]"></span>
							</button>
						</form>

						<!-- 加入購物車：點擊會跳modal -->
						<form th:action="@{/cart}" method="post" class="flex-1"
							onsubmit="return checkLogin(event)">
							<input type="hidden" name="mealId" th:value="${meal.mealId}" />
							<button type="button"
								class="w-full btn-outline rounded-lg px-3 py-2 text-sm text-center transition-all flex items-center justify-center gap-1"
								th:attr="data-mealid=${meal.mealId}"
								onclick="return handleAddToCartClick(this)">
								<i class="fas fa-shopping-cart"></i>
							</button>
						</form>
					</div>


				</div>
				<div th:if="${#lists.isEmpty(mealListData)}"
					class="col-span-full text-center text-milktea-dark py-10">
					查無符合的餐點！</div>
			</div>
		</main>
	</div>

	<!-- 自訂請先登入 Modal -->
	<div id="loginModal"
		class="fixed inset-0 bg-black/30 flex items-center justify-center z-50 hidden">
		<div class="bg-white rounded-2xl p-8 shadow-2xl w-[320px] text-center">
			<div class="text-lg font-bold mb-3 text-[#A67B5B]">請先登入會員</div>
			<div class="text-[#554431] mb-6">您必須先登入會員才能使用此功能，是否前往登入頁？</div>
			<div class="flex gap-4 justify-center">
				<button id="loginConfirmBtn"
					class="bg-[#A67B5B] hover:bg-[#8B5A3C] text-white rounded-full px-5 py-2 font-semibold shadow transition">前往登入</button>
				<button id="loginCancelBtn"
					class="bg-[#F3E5D6] text-[#A67B5B] rounded-full px-5 py-2 font-semibold border border-[#E5D0B6] transition">取消</button>
			</div>
		</div>
	</div>

	<!-- 登出確認 Modal -->
	<div id="logoutModal"
		class="fixed inset-0 bg-black/30 flex items-center justify-center z-50 hidden">
		<div class="bg-white rounded-2xl p-8 shadow-2xl w-[320px] text-center">
			<div class="text-lg font-bold mb-3 text-[#A67B5B]">確定要登出嗎？</div>
			<div class="text-[#554431] mb-6">登出後將返回首頁。</div>
			<div class="flex gap-4 justify-center">
				<button id="logoutConfirmBtn"
					class="bg-[#A67B5B] hover:bg-[#8B5A3C] text-white rounded-full px-5 py-2 font-semibold shadow transition">確定</button>
				<button id="logoutCancelBtn"
					class="bg-[#F3E5D6] text-[#A67B5B] rounded-full px-5 py-2 font-semibold border border-[#E5D0B6] transition">取消</button>
			</div>
		</div>
	</div>

	<!-- ======= Modal 小視窗 ======= -->
	<div id="mealDetailModal"
		class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
		<div
			class="bg-white rounded-2xl p-8 shadow-2xl w-full max-w-md relative">
			<!-- 關閉按鈕 -->
			<button type="button" onclick="closeMealModal()"
				class="absolute top-2 right-2 text-[#A67B5B] text-xl">&times;</button>
			<!-- 餐點圖片 -->
			<div class="flex justify-center mb-4">
				<img id="modalMealPic" src="/images/nopic.png"
					class="w-40 h-40 object-cover rounded-xl border" />
			</div>
			<div class="text-2xl font-bold text-milktea-dark mb-2"
				id="modalMealName">餐點名稱</div>
			<div class="text-[#C7A083] text-lg font-semibold mb-2"
				id="modalMealPrice">NT$ 0</div>
			<div class="flex items-center gap-2 mb-3">
				<span id="modalMealStars" class="text-[#A67B5B] text-sm"></span>
			</div>
			<!-- 數量選擇 -->
			<div class="flex items-center gap-3 mb-5">
				<span>數量：</span>
				<button type="button" onclick="changeQty(-1)"
					class="w-8 h-8 rounded bg-[#E5D0B6]">-</button>
				<input id="modalMealQty" type="number" min="1" value="1"
					class="w-12 text-center border rounded" readonly />
				<button type="button" onclick="changeQty(1)"
					class="w-8 h-8 rounded bg-[#E5D0B6]">+</button>
			</div>
			<form method="post" th:action="@{/cart/add}" id="modalCartForm">
				<input type="hidden" name="mealId" id="modalMealId" /> 
				<input
					type="hidden" name="quantity" id="modalMealFormQty" value="1" /> 
				<input
					type="hidden" name="storeId" id="modalStoreId" />
				<button type="submit"
					class="w-full btn-primary rounded-lg px-4 py-2 mt-2">
					<i class="fas fa-shopping-cart"></i> 加入購物車
				</button>
			</form>
		</div>
	</div>

	<script th:inline="javascript">
	  // 將 mealListData 轉成 JS 陣列（僅需用到的屬性）
	  const mealData = /*[[${mealListData}]]*/ [];
	</script>

	<script>
  // 全域函式：選擇門市後存入 sessionStorage 並重新載入頁面
async function handleStoreChange(selectEl) {
    const newStoreId = selectEl.value;
    if (!newStoreId) return;

    // 先從後端獲取最準確的購物車商品數量
    let itemCount = 0;
    try {
        const response = await fetch('/api/cart/count');
        if (response.ok) {
            const data = await response.json();
            itemCount = data.item_count;
        }
    } catch (error) {
        console.error("查詢購物車數量失敗:", error);
        // 如果查詢失敗，為安全起見，直接跳轉，不提示
        window.location.href = `/menu?storeId=${newStoreId}`;
        return;
    }
    
    const currentCartStoreId = sessionStorage.getItem("cartStoreId");

    // 【核心修正】現在的判斷依據是真實的商品數量 itemCount
    if (itemCount > 0 && currentCartStoreId && currentCartStoreId !== newStoreId) {
        if (confirm("您的購物車內尚有商品，更換門市將會清空購物車，確定要繼續嗎？")) {
            // 使用者同意，呼叫後端 API 清空購物車
            clearCartForStoreChange(newStoreId);
        } else {
            // 使用者取消，將下拉選單恢復原狀
            selectEl.value = currentCartStoreId;
            return;
        }
    } else {
        // 如果購物車是空的，或選擇的門市與原來相同，直接導向新頁面
        window.location.href = `/menu?storeId=${newStoreId}`;
    }
}

// 【新增】一個專門用於清空購物車並處理後續動作的函式
async function clearCartForStoreChange(newStoreId) {
    if (!memberId) {
        alert("請先登入會員");
        return;
    }
    // 呼叫後端清空購物車的 API (DELETE /cart/member/{id})
    try {
        const response = await fetch(`/cart/member/${memberId}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('清空購物車失敗');

      	//直接導向帶有 storeId 參數的新 URL
        window.location.href = `/menu?storeId=${newStoreId}`;
        
    } catch(error) {
        alert("清空購物車時發生錯誤，請稍後再試。");
    }
}

  // 顯示請先登入的彈窗
  function checkLogin(e) {
      if (!isLoggedIn) {
          if (e) e.preventDefault();
          showLoginModal();
          return false;
      }
      return true;
  }

  function handleAddToCartClick(btnElement) {
      if (!checkLogin()) {
          return false;
      }
      openMealModal(btnElement);
      return false;
  }

  function showLoginModal() {
      document.getElementById('loginModal').classList.remove('hidden');
  }
  function hideLoginModal() {
      document.getElementById('loginModal').classList.add('hidden');
  }

  function showLogoutModal() {
      document.getElementById('logoutModal').classList.remove('hidden');
  }
  function hideLogoutModal() {
      document.getElementById('logoutModal').classList.add('hidden');
  }

  let currentMeal = null;

  function openMealModal(btn) {
	    // 【關鍵新增】第一步：先檢查是否已選擇門市
	    const storeId = sessionStorage.getItem("selectedStoreId");
	    if (!storeId) {
	        // 如果沒有選擇門市，跳出提示，並終止後續操作
	        alert("請先從頁面上方的下拉選單中選擇一個取餐門市！");
	        return; // 直接結束函式
	    }

	    const mealId = Number(btn.getAttribute('data-mealid'));
	    currentMeal = mealData.find(m => m.mealId === mealId);
	    if (!currentMeal) return;

	    document.getElementById('modalMealId').value = currentMeal.mealId;
	    document.getElementById('modalMealPic').src = currentMeal.mealPicUrl;
	    document.getElementById('modalMealName').textContent = currentMeal.mealName;
	    document.getElementById('modalMealPrice').textContent = 'NT$ ' + currentMeal.mealPrice;
	    document.getElementById('modalMealStars').innerHTML = renderStars(currentMeal.avgStars ?? 0);
	    document.getElementById('modalMealQty').value = 1;
	    document.getElementById('modalMealFormQty').value = 1;

	    // 將已確認存在的 storeId 填入表單
	    document.getElementById('modalStoreId').value = storeId;

	    document.getElementById('mealDetailModal').classList.remove('hidden');
	}

  function closeMealModal() {
      document.getElementById('mealDetailModal').classList.add('hidden');
  }

  function changeQty(delta) {
      let input = document.getElementById('modalMealQty');
      let val = parseInt(input.value) + delta;
      if (val < 1) val = 1;
      input.value = val;
      document.getElementById('modalMealFormQty').value = val;
  }

  function renderStars(score, max=5) {
	  if (score == null || isNaN(score)) score = 0; // 預設 0 分
	  let html = '';
	  for(let i = 1; i <= max; i++) {
	    if (score >= i) { // 全星
	      html += '<i class="fas fa-star text-yellow-400"></i>';
	    } else if (score > i-1 && score < i) { // 半星
	      html += '<i class="fas fa-star-half-alt text-yellow-400"></i>';
	    } else { // 空星
	      html += '<i class="far fa-star text-[#DED0B6]"></i>';
	    }
	  }
	  if (score === 0) {
		    html += ` <span class="ml-1 text-sm text-[#9D7C64]">尚無評分</span>`;
		  } else {
		    html += ` <span class="ml-1 text-sm text-[#9D7C64]">${score.toFixed(1)} / 5</span>`;
		  }
	  return html;
	}
  
	//✅ 新增：顯示提示訊息的函式 (置中 + 可靠的自動關閉)
    function showToast(message, isSuccess = true) {
        const container = document.getElementById('toast-container');
        if (!container) return;

        // 為了確保畫面中央永遠只有一個提示，先清空容器
        container.innerHTML = '';

        // 建立 toast 元素
        const toast = document.createElement('div');
        const bgColor = isSuccess ? 'bg-[#A67B5B]' : 'bg-red-500';
        const icon = isSuccess ? '<i class="fas fa-check-circle mr-3"></i>' : '<i class="fas fa-times-circle mr-3"></i>';

        // 使用縮放與透明度動畫，並重新啟用滑鼠事件
        toast.className = `pointer-events-auto flex items-center text-white text-lg font-semibold px-6 py-4 rounded-xl shadow-2xl transform transition-all duration-300 opacity-0 scale-90`;
        toast.classList.add(bgColor);
        toast.innerHTML = `${icon} ${message}`;

        container.appendChild(toast);

        // --- 觸發「出現」動畫 ---
        // 使用一個極短的延遲，確保瀏覽器能捕捉到 class 的變化並觸發 transition
        setTimeout(() => {
            toast.classList.remove('opacity-0', 'scale-90');
            toast.classList.add('opacity-100', 'scale-100');
        }, 10);

        // --- 觸發「消失」動畫 ---
        // 設定 2.5 秒後開始消失
        setTimeout(() => {
            toast.classList.remove('opacity-100', 'scale-100');
            toast.classList.add('opacity-0', 'scale-90');

            // 【關鍵修復】在淡出動畫（300ms）結束後，直接從 DOM 中移除元素
            // 這樣就不再依賴可能不觸發的 'transitionend' 事件
            setTimeout(() => {
                if (container.contains(toast)) {
                    container.removeChild(toast);
                }
            }, 300); // 這個時間要和 CSS 的 duration-300 匹配

        }, 1200); // 提示顯示 2.5 秒
    }

    // ✅ 更新餐點星星顯示
  function updateMealStars() {
      fetch('/api/meals/ratings')
          .then(res => res.json())
          .then(data => {
              data.forEach(meal => {
                  document.querySelectorAll(`.star-display[data-meal-id='${meal.mealId}']`).forEach(el => {
                      el.innerHTML = renderStars(meal.avgStars);
                  });
              });
          });
  }

  // ✅ 整合所有 DOMContentLoaded 邏輯
  document.addEventListener('DOMContentLoaded', function () {
	  
	//優先從 URL 同步 storeId 到 sessionStorage
      const urlParams = new URLSearchParams(window.location.search);
      const storeIdFromUrl = urlParams.get('storeId');

      if (storeIdFromUrl) {
          // 如果 URL 中有 storeId，將它設定為 sessionStorage 的值，確保它是最新的
          sessionStorage.setItem("selectedStoreId", storeIdFromUrl);
          sessionStorage.setItem("cartStoreId", storeIdFromUrl); // 同時也更新購物車門市ID
      }
	  
      // 1. 套用 sessionStorage 中的 storeId
      const selectedStoreId = sessionStorage.getItem("selectedStoreId");
      if (selectedStoreId) {
          const selector = document.getElementById('storeSelector');
          if (selector) selector.value = selectedStoreId;
      }

      // 2. 登入 modal 按鈕
      document.getElementById('loginConfirmBtn').onclick = () => {
          window.location.href = '/api/v1/auth/member-login';
      };
      document.getElementById('loginCancelBtn').onclick = hideLoginModal;

      // 3. 登出 modal 行為
      const logoutBtn = document.getElementById('logoutBtn');
      const logoutForm = document.getElementById('logoutForm');
      const logoutConfirmBtn = document.getElementById('logoutConfirmBtn');
      const logoutCancelBtn = document.getElementById('logoutCancelBtn');

      if (logoutBtn) {
          logoutBtn.onclick = function (e) {
              e.preventDefault();
              showLogoutModal();
          };
      }

      if (logoutCancelBtn) {
          logoutCancelBtn.onclick = hideLogoutModal;
      }

      if (logoutConfirmBtn && logoutForm) {
          logoutConfirmBtn.onclick = function () {
              hideLogoutModal();
              fetch(logoutForm.action, {
                  method: 'POST',
                  credentials: 'same-origin'
              }).then(res => {
                  if (res.ok) {
                      window.location.href = '/welcome';
                  } else {
                      alert('登出失敗，請稍後再試！');
                  }
              }).catch(error => {
                  console.error('登出請求發生錯誤:', error);
                  alert('登出失敗，請檢查網路連線或稍後再試！');
              });
          };
      }

      // 4. 點擊 modal 背景可關閉
      const loginModal = document.getElementById('loginModal');
      const logoutModal = document.getElementById('logoutModal');
      const mealDetailModal = document.getElementById('mealDetailModal');

      if (loginModal) {
          loginModal.addEventListener('click', function (e) {
              if (e.target === loginModal) hideLoginModal();
          });
      }

      if (logoutModal) {
          logoutModal.addEventListener('click', function (e) {
              if (e.target === logoutModal) hideLogoutModal();
          });
      }

      if (mealDetailModal) {
          mealDetailModal.addEventListener('click', function (e) {
              if (e.target === mealDetailModal) closeMealModal();
          });
      }

      // 5. 初始星星顯示與定時刷新
      updateMealStars();
      setInterval(updateMealStars, 30000);
   // ✅ 新增：攔截並修改 Modal 中的購物車表單提交行為
      const modalCartForm = document.getElementById('modalCartForm');
      if (modalCartForm) {
          modalCartForm.addEventListener('submit', function (e) {
              // 1. 阻止表單的預設提交行為 (避免頁面刷新)
              e.preventDefault();

              // 2. 獲取表單資料
              const formData = new FormData(modalCartForm);
              const data = new URLSearchParams(formData);
              
           // 【新增】當成功加入第一個商品時，將門市ID記錄到 sessionStorage
              const currentCartStoreId = sessionStorage.getItem("cartStoreId");
              if (!currentCartStoreId) {
                   sessionStorage.setItem("cartStoreId", formData.get("storeId"));
              }
              // 3. 使用 Fetch API 將資料送到後端
              fetch(modalCartForm.action, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/x-www-form-urlencoded',
                  },
                  body: data
              })
              .then(response => {
                  // 4. 根據伺服器回應判斷是否成功
                  if (response.ok) {
                      // 成功加入購物車
                      closeMealModal(); // 關閉 Modal
                      showToast('✅ 已成功加入購物車！'); // 顯示成功提示
                  } else {
                      // 處理失敗情況
                      response.text().then(text => {
                           // 如果後端有回傳錯誤訊息，可以顯示它
                           showToast(`加入失敗: ${text || '請稍後再試'}`, false);
                      });
                  }
              })
              .catch(error => {
                  // 5. 處理網路錯誤
                  console.error('加入購物車請求失敗:', error);
                  showToast('網路錯誤，請檢查連線。', false);
              });
          });
      }
  });
      
</script>
<script>
// 登出 Modal 控制
function confirmLogout() {
    document.getElementById('logoutModal').classList.add('show');
}
function closeLogoutModal() {
    document.getElementById('logoutModal').classList.remove('show');
}
function logout() {
    document.getElementById('logoutLoading').style.display = 'flex';
    // fetch 登出
    fetch('/api/v1/auth/logout', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (response.ok) {
            window.location.reload();
        } else {
            alert('登出失敗，請稍後再試');
            closeLogoutModal();
            document.getElementById('logoutLoading').style.display = 'none';
        }
    })
    .catch(error => {
        alert('登出失敗，請稍後再試');
        closeLogoutModal();
        document.getElementById('logoutLoading').style.display = 'none';
    });
}

// 點擊 modal 背景自動關閉
document.addEventListener('DOMContentLoaded', function() {
    const logoutModal = document.getElementById('logoutModal');
    if (logoutModal) {
        logoutModal.addEventListener('click', function(e) {
            if (e.target === logoutModal) closeLogoutModal();
        });
    }
});
</script>



	<footer class="footer">
            <div class="copyright">
                © 2025 EatFast 早餐店 - 版權所有 | 為您提供最優質的早餐服務
            </div>
    </footer>


</body>
</html>