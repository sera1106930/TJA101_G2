<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>新增餐點 - EatFast 後台</title>

    <link rel="stylesheet" th:href="@{/webjars/bootstrap/4.2.1/css/bootstrap.min.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" th:href="@{/css/member/style.css}" />
</head>
<body>

<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center" th:href="@{/meal/select_page_meal}">
            <img th:src="@{/images/eatfasticon.png}" alt="EatFast Icon" width="40" height="40" class="mr-2">
            <span style="font-weight: 500; font-size: 1.25rem;">新增餐點 - EatFast 後台</span>
        </a>
        <a class="btn btn-outline-light ml-auto" th:href="@{/meal/select_page_meal}">
            <i class="fas fa-home"></i> 回首頁
        </a>
    </div>
</nav>

<div class="container mt-5 pt-4">
    <div class="card mx-auto" style="max-width: 600px;">
        <div class="card-header">
            <i class="fas fa-plus-circle"></i> 請輸入餐點資料
        </div>
        <div class="card-body">
        	<form method="post" th:action="@{/meal/insert}" th:object="${mealEntity}" enctype="multipart/form-data">

                <div th:if="${#fields.hasErrors('*')}" class="alert alert-danger mb-3">
                    <strong>請修正以下錯誤：</strong>
                    <ul>
                        <li th:each="err : ${#fields.errors('*')}" th:text="${err}"></li>
                    </ul>
                </div>

                <div class="form-group">
				    <label for="mealType">餐點種類：</label>
				    <select id="mealType" class="form-control" th:field="*{mealType.mealTypeId}"
				            onchange="hideErrorMessage('mealType.mealTypeId.errors');">
				        <option value=""> -- 請選擇種類 -- </option>
				        <option th:each="mealTypeEntity : ${mealTypeListData}"
				                th:value="${mealTypeEntity.mealTypeId}"
				                th:text="${mealTypeEntity.mealName}"
				                th:selected="${mealTypeEntity.mealTypeId == mealEntity.mealType.mealTypeId} ? 'selected'">
				        </option>
				    </select>
				    <span class="text-danger" th:if="${#fields.hasErrors('mealType.mealTypeId')}" th:errors="*{mealType.mealTypeId}" id="mealType.mealTypeId.errors"></span>
				</div>
				
				<div class="form-group">
				    <label for="mealName">餐點名稱：</label>
				    <input type="text" id="mealName" class="form-control" th:field="*{mealName}"
				           oninput="hideErrorMessage('mealName.errors');" />
				    <span class="text-danger" th:if="${#fields.hasErrors('mealName')}" th:errors="*{mealName}" id="mealName.errors"></span>
				</div>
                
                <div class="form-group">
                    <label for="mealPrice">餐點價格：</label>
                    <input type="text" id="mealPrice" class="form-control" th:field="*{mealPrice}"
                           oninput="hideErrorMessage('mealPrice.errors');" />
                    <span class="text-danger" th:if="${#fields.hasErrors('mealPrice')}" th:errors="*{mealPrice}" id="mealPrice.errors"></span>
                </div>
                
				<div class="form-group">
				    <div class="d-flex align-items-center mb-2"> 
				        <label class="me-3 mb-0">餐點狀態：</label> 
				        
				        <div class="th-generated-wrapper"> <div class="form-check me-3"> 
				                <input class="form-check-input" type="radio" th:field="*{status}" id="statusOn" value="1">
				                <label class="form-check-label" for="statusOn">上架</label>
				            </div>
				            <div class="form-check">
				                <input class="form-check-input" type="radio" th:field="*{status}" id="statusOff" value="0">
				                <label class="form-check-label" for="statusOff">下架</label>
				            </div>
				        </div>
				    </div>
				    <span class="text-danger" th:if="${#fields.hasErrors('status')}" th:errors="*{status}" id="status.errors"></span>
				</div>
                
                <div class="form-group">
                    <label for="mealPic">餐點圖片：</label>
                    <input type="file" id="mealPic" name="mealPic" class="form-control-file" accept="image/png, image/jpeg, image/gif"
                           onchange="hideErrorMessage('mealPic.errors'); previewFile();" />
					<span class="text-danger" th:utext="${errorMessage}" id="mealPic.errors"></span>
                	<div id="mealPicPreview" class="mt-2">
                        </div>
                </div>

                <div class="d-flex justify-content-center">
                    <button type="submit" class="btn btn-primary mx-2" id="submitButton"><i class="fas fa-check"></i> 送出新增</button>
                    <a th:href="@{/meal/select_page_meal}" class="btn btn-secondary mx-2"><i class="fas fa-times"></i> 返回管理</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script th:src="@{/webjars/jquery/3.3.1/jquery.min.js}"></script>
<script th:src="@{/webjars/popper.js/1.14.3/umd/popper.min.js}"></script>
<script th:src="@{/webjars/bootstrap/4.2.1/js/bootstrap.min.js}"></script>

<script type="text/javascript">
// 等待 DOM 完全載入後執行
document.addEventListener('DOMContentLoaded', function() {
    const mealPicInput = document.getElementById("mealPic");
    const submitButton = document.getElementById("submitButton"); // 修改 ID 以避免混淆
    const mealPicPreview = document.getElementById("mealPicPreview"); // 修改 ID

    // 清除提示訊息的函式 (名稱更明確)
    // d: 指的是錯誤訊息元素的 ID (e.g., 'mealName.errors')
    function hideErrorMessage(elementId) {
        const errorElement = document.getElementById(elementId);
        if (errorElement) {
            errorElement.style.display = "none";
        }
    }

    // 檔案讀取器支援檢查
    const filereader_support = typeof FileReader != 'undefined';
    if (!filereader_support) {
        alert("您的瀏覽器不支援 FileReader API，無法預覽圖片。");
    }
    
    // 接受的圖片類型
    const acceptedTypes = {
        'image/png': true,
        'image/jpeg': true,
        'image/gif': true
    };
        
    // 處理圖片預覽的函式
    function previewFile() {
        // 獲取所有選取的檔案 (目前只處理單一檔案)
        const files = mealPicInput.files;

        // 清除現有的預覽圖片，避免重複顯示
        mealPicPreview.innerHTML = '';
        submitButton.disabled = false; // 預設啟用送出按鈕

        if (files.length === 0) {
            // 如果沒有選擇檔案，則清除預覽並啟用送出按鈕
            return;
        }

        const file = files[0]; // 只處理第一個檔案

        if (filereader_support && acceptedTypes[file.type]) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const image = new Image();
                image.src = event.target.result;
                image.style.maxWidth = '150px'; // 設定預覽圖片最大寬度
                image.style.maxHeight = '100px'; // 設定預覽圖片最大高度
                image.style.border = '1px solid #ddd'; // 邊框更現代
                image.style.borderRadius = '4px'; // 圓角
                image.style.objectFit = 'contain'; // 確保圖片完整顯示
                mealPicPreview.appendChild(image); // 將圖片加入預覽區域
            };
            reader.readAsDataURL(file); // 以 Data URL 格式讀取檔案內容
        } else {
            // 如果檔案類型不符，顯示錯誤訊息並禁用送出按鈕
            mealPicPreview.innerHTML = `
                <div style="text-align: left; color: red;">
                    ● 檔名: ${file.name}<br>
                    ● 檔案類型: ${file.type}<br>
                    ● 大小: ${file.size} bytes<br>
                    ● 僅接受圖片類型: <b>PNG, JPEG, GIF</b>
                </div>
            `;
            submitButton.disabled = true; // 禁用送出按鈕
        }
    }

    // 將 hideErrorMessage 函式暴露到全域，以便 Thymeleaf 的 onclick 可以調用
    window.hideErrorMessage = hideErrorMessage;

    // 將 previewFile 函式綁定到 input 的 change 事件上
    // 注意：這裡移除了 HTML 上的 onchange="..."，改用 JS 綁定
    mealPicInput.addEventListener('change', previewFile);

    // 當頁面載入時，如果 mealPicInput 已經有值 (例如，編輯時顯示舊圖片)，則預覽
    if (mealPicInput.files.length > 0) {
        previewFile();
    }
});
</script>

</body>
</html>